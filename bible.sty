%
% LaTeX package for typesetting the Bible in various languages.
% Copyright (c) 2002-2007 Tigran Aivazian <tigran@aivazian.fsnet.co.uk>,
%                         Vladimir Volovich <vvv@vsu.ru>.
%

\NeedsTeXFormat{LaTeX2e}[2000/06/01]
\ProvidesPackage{bible}[2004/03/16 v2.0]

\@for\tmp@a:=%
  chapbookm,parvs,noinlinetitle,pmnone,bindrtol,lrfn,nomarnvs,nogeometry,lulubighb,luluhb,lettrine,titledot,%
  bigfoot,nojustfn,nofnpara,keepfnmark,romanchap,dropcaps,nobooknewpage,chvsrevmarn,%
  nochpar,embedsrc,nofn,nodiacritics,fwnp,vssup,doublecol,xrefs,nohyperref,vsbookmarks,%
  hebrew,syriac,armenian,romanian,german,swedish,french,polish,hungarian,%
  dutch,italian,spanish,portuguese,latin,english,slavonic,russian,%
  coptic,swahili,bulgarian,ukrainian,greek%
\do{%
  \expandafter\newif\csname if\tmp@a\endcsname
  \edef\tmp@b{{\tmp@a}{\expandafter\noexpand\csname \tmp@a true\endcsname}}%
  \expandafter\DeclareOption\tmp@b
}
\DeclareOption*{%
  \PackageError{bible}%
  {Unknown option `\CurrentOption' passed}%
  {You might have misspelt the name of the option, or used an obsolete option.}%
}
\ProcessOptions

\RequirePackage{fix-cm} % as early as possible

% to be able to use \hyphenchar other than ASCII "-" we use
% \hyph{a}{b}{c} instead of \discretionary{a-}{b}{c} (see zohrab/tex/*.tex)
\protected\def\hyph#1#2#3{\discretionary{#1\char\hyphenchar\font}{#2}{#3}}

\ifbigfoot
  %\RequirePackage{pagestyle}
  \RequirePackage{bigfoot}
  \DeclareNewFootnote[para]{default}
  %\DeclareNewFootnote{default}
  \MakePerPage{footnotedefault}

 % \renewcommand\vtypefraction{10}
 % \renewcommand\hfootfraction{10}
 % \def\@makefnbreak{\FN@magicglue {\footnotesep+\dp\strutbox}%
 %   {\footnotesep+\dp\strutbox+\baselineskip}%
 %   {\footnotesep+\dp\strutbox+0.5\baselineskip}%
 %   {\footnotesep+\dp\strutbox+2\baselineskip}{-200}{-200}}

  \let\default@makefnbreak\@makefnbreak
  \def\justified@makefnbreak{\unskip\space}
  \ifnojustfn\else\let\@makefnbreak\justified@makefnbreak\fi
\else
  \ifnofnpara
    \RequirePackage[perpage]{footmisc}
  \else
    \RequirePackage[para]{footmisc}
%\RequirePackage[para*]{manyfoot}
%\newfootnote[para]{A}
%\let\footnote\footnoteA
%\protected\def\footnotetext#1{\FootnotetextA{}{#1}}
  \fi
\fi% else of \ifbigfoot

%\RequirePackage{ifpdf,ifxetex,fancyhdr,color,etex,fixltx2e,tabulary,longtable,tiqwah,amssymb,pifont,textcomp,multicol,bibmnote,needspace}
\RequirePackage{ifpdf,ifxetex,fancyhdr,color,etex,fixltx2e,tabulary,longtable,amssymb,pifont,textcomp,multicol,bibmnote,needspace}
\ifxetex\RequirePackage{xltxtra}\fi % also loads xunicode, fontspec

% redefine the \mpr@comma macro from bibmnote.sty
\def\mpr@comma{\unskip\ifhebrew\te{,}\else,\fi\space}
% redefine the font used by marginal notes
\protected\def\marnfont{%
  \ifhebrew\usefont{LTQ}{tiqwah}{m}{n}\fi
  \maintextfalse
  \small
}

% the default 20 is too small.
\setcounter{LTchunksize}{60}

\ifnogeometry\else
\RequirePackage[%\ifpdf pdftex\else dvips\fi,
  \iflulubighb
    headheight=18.4pt,
  \else
    headheight=14pt,
  \fi
  headsep=1pt,
  \ifluluhb
    vmargin={0.5in,0.9in},
    \ifhebrew
      hmargin={0.8in,0.6in},
    \else
      hmargin={0.9in,0.7in},
    \fi
  \else
    \iflulubighb
      vmargin={0.6in},
      hmargin={0.9in},
    \else
      vmargin={1.2cm,1.1cm},
      \ifhebrew
        hmargin={2.3cm,1.5cm},
      \else
        hmargin={1.5cm,2.3cm},
      \fi
    \fi
  \fi
  twoside=\if@twoside true\else false\fi,
  \ifluluhb
    papersize={6in,9in}
  \else
    \iflulubighb
      papersize={8.25in,10.75in}
    \else
      a4paper
    \fi
  \fi
]{geometry}
% fix page dimentions in xelatex - can be dropped when geometry.sty
% will become xetex-aware and/or geometry.cfg in texlive will be fixed
\@ifundefined{XeTeXversion}{}{\def\Gm@checkdrivers{\Gm@setdriver{pdftex}}}
\fi % nogeometry

\renewcommand{\headrulewidth}{0mm}
\setlength{\parskip}{0mm}
\ifxetex\else
\setlength{\skip\footins}{5mm minus3mm}
\dimen\footins=15cm
\fi

% \bibannot adds a tooltip containing #2 to the word given in #1
\newcounter{tooltip@counter}   
\setcounter{tooltip@counter}{0}

\newcommand{\bibannot}[2]{%
  \leavevmode
  \stepcounter{tooltip@counter}%
  \pdfstringdef\tooltip@pdfstring{#2}%
  % For each annotation the /T field must be different.
  % This is not supported by \pdfstartlink, if the link
  % is broken across lines.
  {%
    \pdfstartlink user{%
      /Subtype/Widget%
      /T(tooltip\number\value{tooltip@counter})% unique name
      /FT/Btn%
      /TU(\tooltip@pdfstring)% tooltip text
    }% 
    #1%
    \pdfendlink
  }%
}

% \bibemptypages generates empty "For Notes" pages at the end of Bibles
% (used to fill up the number of pages to the closest number that
%  divides by the signature size, usually 16)
% #1 -- the number of pages to insert
% #2 -- the text to put in the heading
\newcommand{\bibemptypages}[2]{%
  \newcount\npages
  \npages=0
  \clp
  \fancyhead[L,R]{}
  \bibmark{book}{#2}
  \bibpdfbookmark{#2}{notes}
  \loop
  \ifnum\npages<#1
    \null\newpage
    \advance\npages by1
  \repeat
}

% variant reading separator in the note
\newcommand{\vsep}{{\normalfont\textbrokenbar}}
% note separator in the footnote
\newcommand{\nsep}{{\normalfont\textbardbl}}

% some languages may redefine these.
\definecolor{grey}{rgb}{0.4, 0.4, 0.4}
\newcommand{\bibdropcapscolor}{black}
\newcommand{\bibtitlemain}[1]{\begingroup\vspace{1ex}\Huge\bfseries\MakeUppercase{#1}\endgroup}
\newcommand{\bibtocfont}{\fontsize{11}{13.2}\selectfont}
\newcommand{\bibtocheadfont}{\Large\scshape}
\newcommand{\bibfnchapsize}{\ifhebrew\large\else\bfseries\normalsize\fi}
\newcommand{\bibfnvssize}{\bfseries\small}
\newcommand{\bibfnvsmark}{\textlatin{v.}}
\newcommand{\bibtitlefont}{\huge\ifhebrew\else\scshape\fi}
\newcommand{\bibfwnpsize}{\small}
\newcommand{\bibqtfont}{\bfseries\slshape}
\newcommand{\bibmarnchfont}{\large\ifhebrew\else\bfseries\upshape\fi}
\newcommand{\bibmarnvsfont}{\footnotesize\mdseries\upshape}
\newcommand{\bibheadfont}{\normalsize\scshape}
\newcommand{\bibheadchapsize}{\normalfont\normalsize}
\newcommand{\bibheadversesize}{\normalfont\footnotesize}
\newcommand{\bibheadpagesize}{\normalfont\footnotesize}
\newcommand{\bibpage}{\pagename}
\newcommand{\bibpsalmname}{Psalm}
\newcommand{\bibchapname}{\chaptername}
\newcommand{\bibversename}{Verse}
\newcommand{\bibcontname}{\contentsname}
\newcommand{\bibnotelang}[1]{#1}
\newcommand{\bibvar}[1]{[#1]}
\newcommand{\bibempty}{\ensuremath{\varnothing}}
\newcommand{\bibfnvsnumspace}{\nobreakspace}

% these hooks allow to execute some commands before and after the main
% content of \bibbook[descr].
% For example, using \bibbookend one can change the font of the main text.
\newcommand{\bibbookbegin}{}
\newcommand{\bibbookend}{}

\newcommand{\te}[1]{\textlatin{#1}}
\newcommand{\ti}[1]{\textlatin{\itshape #1}}
\newcommand{\bibcline}[1]{\vspace{4ex}\begin{center}\normalsize\scshape#1\end{center}\vspace{1ex}}

\newif\ifmaintext

% mark the beginning and end of a variant in the text.
\newcommand{\vb}{\ensuremath{\ulcorner\kern-0.2em}}
\newcommand{\ve}{\ensuremath{\kern-0.2em\urcorner}}

\newcommand{\bibssfont}{}

\def\process@lettrine#1{\MakeUppercase{#1}}

% \src macro to print source names
\def\src#1{\src@do@vbar#1|\relax|}
\def\src@do@vbar#1|{%
  \ifx\relax#1%
    \empty
  \else
    \bib@src#1[]\relax
    \expandafter\src@maybe@put@sep
  \fi
}
\def\src@maybe@put@sep#1|{\ifx\relax#1\empty\else\bib@srcsep\fi\src@do@vbar#1|}
\def\bib@src#1[#2]{%
  \def\@tempa{#2}%
  \ifhebrew\beginL\fi
  \@ifundefined{bib@src@#1}{\ifhebrew\hebrewnum{#1}\else\te{#1}\fi}{\@nameuse{bib@src@#1}}%
  \ifx\@tempa\@empty\else
    \@ifundefined{bib@srcarg@#1}{\bib@srcarg@default{#2}}{\@nameuse{bib@srcarg@#1}{#2}}%
  \fi
  \ifhebrew\endL\fi
  \ifx\@tempa\@empty\else\expandafter\@gobblebraces\fi
}
\def\@gobblebraces[]{}
\def\declarebibsrc#1#2{%
  \@namedef{bib@src@#1}{#2}%
  \@ifnextchar[{\define@bibsrc@arg{#1}}{}}
\def\define@bibsrc@arg#1[#2]{\@namedef{bib@srcarg@#1}##1{#2}}
\def\bib@srcarg@default#1{\ts{\te{\bibssfont#1}}}
\def\bib@srcsep{\hspace{\fnsymskip}}

\TeXXeTstate=1

%\chvsrevmarnfalse

\ifhebrew
\chvsrevmarntrue
\ifgreek
  % for Greek in Hebrew footnotes.
  \def\hebgk#1{\beginL\textgreek{#1}\endL}
\else
  \RequirePackage[british]{babel}
\fi
\RequirePackage{rotating,tabularx,newcent}
\@input{tex/hebmac.tex}

% massoretic seder mark in the margin (used by tnk)
% \seder* also prints a circle for the footnote.
% the seder signs are numbered sequentially and
% the counter is reset at the start of each book
\newcommand*{\seder}{%
  \leavevmode\unskip
  \stepcounter{sedernum}%
  \@ifstar{\bibmarn{\mpr@sederpcr{\thesedernum}}\ignorespaces}{\bibmarn{\mpr@seder{\thesedernum}}\ignorespaces}%
}
\protected\def\mpr@seder#1{%
  \usefont{LTQ}{tiqwah}{m}{n}\accent144s\m{_{#1}}%
}
\protected\def\mpr@sederpcr#1{%
  \usefont{LTQ}{tiqwah}{m}{n}\char177\accent144s\m{_{#1}}%
}

\renewcommand{\footnotesize}{\small}

% for wlc
\def\nuninvmarn{\bibmarn{\mpr@nuninv}}
\protected\def\mpr@nuninv{\Large\nuninv}

\iffwnp
  \def\fwnp@hook{%
    \@ifundefined{fwnp@\thepage}{}{%
      \nointerlineskip
      \vbox to\z@{\kern3\p@\leftline{\maintextfalse\bibfwnpsize\begin{hebrew}\@nameuse{fwnp@\thepage}\end{hebrew}}\vss}%
      \nointerlineskip
    }%
  }
  \def\latex@makecol{%
    \ifvoid \footins
      \setbox \@outputbox \vbox \bgroup
        \boxmaxdepth \@maxdepth
        \unvbox \@cclv
        \fwnp@hook
      \egroup
    \else
      \setbox \@outputbox \vbox \bgroup
        \boxmaxdepth \@maxdepth
        \unvbox \@cclv
        \fwnp@hook
        \vskip \skip \footins
        \color@begingroup
        \normalcolor
        \footnoterule
        \ifnofnpara
          \unvbox \footins
        \else
          \global \setbox \FN@tempboxc \vbox {\makefootnoteparagraph }%
          \unvbox \FN@tempboxc
        \fi
        \color@endgroup
      \egroup
    \fi
    \xdef \@freelist {\@freelist \@midlist }%
    \global \let \@midlist \@empty
    \@combinefloats
    \ifvbox \@kludgeins
      \@makespecialcolbox
    \else
      \setbox \@outputbox \vbox to\@colht {%
        \@texttop
        \dimen@ \dp \@outputbox
        \unvbox \@outputbox
        \vskip -\dimen@
        \@textbottom
      }%
    \fi
    \global \maxdepth \@maxdepth
  }
  \def\@gobble@empty#{\@gobble}
  \def\Hcomb@nd#1#2#3#4#5#6#7{\string\Hc{#1}{\l@norm{#1}}}
  \let\orig@Hword\Hword
  \let\orig@Hmaqqeph\Hmaqqeph
  \def\Hword#1{%
    \ifmaintext
      \stepcounter{wordnum}%
      \protected@write\tf@fwnp{%
        \let\Hprepos\@gobbletwo
        \let\Hpostpos\@gobbletwo
        \let\Hbigrequestedtrue\@gobble@empty
        \let\Hsmallrequestedtrue\@gobble@empty
        \let\Hcomb\Hcomb@nd
      }{\thewordnum\space\thepage\space\string\Hword{#1}}%
    \fi
    \orig@Hword{#1}%
  }
  \def\Hmaqqeph{\record@maqqeph\orig@Hmaqqeph}
  \def\record@maqqeph{%
    \ifmaintext
      \stepcounter{wordnum}%
      \protected@write\tf@fwnp{}{\thewordnum\space\thepage\space\string\Hmaqqeph{}}%
    \fi
  }
  \newcounter{wordnum}
  \@input{\jobname.fwnp}
  \newwrite\tf@fwnp
  \immediate\openout\tf@fwnp\jobname.words
\else
  \let\record@maqqeph\@empty
\fi

\let\orig@Hcomb\Hcomb
\let\orig@Hprepos\Hprepos
\let\orig@Hpostpos\Hpostpos
\let\orig@Hlineola\Hlineola
\let\orig@Hmaqqephcircellus\Hmaqqephcircellus
\let\orig@Hlineolacircellus\Hlineolacircellus
\let\orig@Hisocircellus\Hisocircellus
\def\Hcomb#1#2#3#4#5#6#7{%
  \ifnodiacritics
    \edef\H@args{{#1}{\l@norm{#1}}{}{}{\H@testa{#5}}{\H@testa{#6}}{}}%
  \else
    \edef\H@args{{#1}{#2}{#3}{#4}{\H@testb{#5}}{\H@testb{#6}}{#7}}%
  \fi
  \expandafter\orig@Hcomb\H@args
}
\def\l@norm#1{\@ifundefined{l@norm@#1}{#1}{\@nameuse{l@norm@#1}}}
\def\l@norm@S{W/}
\def\l@norm@W{W/}
\def\l@norm@emp{//}
\def\Hprepos#1#2{%
  \ifnodiacritics\else
    \orig@Hprepos{#1}{#2}%
  \fi
}
\def\Hpostpos#1#2{%
  \ifnodiacritics
    \orig@Hpostpos{}{\H@testa{#2}}%
  \else
    \orig@Hpostpos{#1}{\H@testb{#2}}%
  \fi
}
\def\Hlineola{\ifnodiacritics\else\orig@Hlineola\fi}
\def\Hmaqqephcircellus{\ifnofn\Hmaqqeph\else\record@maqqeph\orig@Hmaqqephcircellus\fi}
\def\Hlineolacircellus{%
  \ifnodiacritics
    \ifnofn\else\Hisocircellus\fi
  \else
    \ifnofn\orig@Hlineola\else\orig@Hlineolacircellus\fi
  \fi
}
\def\Hisocircellus{\ifnofn\else\orig@Hisocircellus\fi}
\def\H@testa#1{% called when \nodiacriticstrue
  \ifnofn\else\@ifundefined{H@test@#1}{}{#1}\fi
}
\def\H@testb#1{% called when \nodiacriticsfalse
  \ifnofn\@ifundefined{H@test@#1}{#1}{}\else#1\fi
}
\let\H@test@pcr\@empty
\let\H@test@cir\@empty

\def\Hphantom#1{\phantom{\maintextfalse#1}}

\def\switchbook#1#2#3#4{%
  \global\@namedef{Parent1}{#4.1}%
  \label{#4}%
  \bib@raise@anchor{\hypertarget{#4}{}}%
  \def\deferred@bibpdfbookmark{\bib@raise@anchor{\bibpdfbookmark[1]{#3}{#4}}}%
  \bibmark{book}{#1}%
  \bibmark{oddhead}{#1}%
  \bibrevmarn{\mpr@switchbook{\detokenize{#2}}}%
}
\protected\def\mpr@switchbook#1{\normalsize\maintextfalse#1}

% for "inline" books: Joel, Amos, ...
\newcommand{\tnkbookinline}[4]{%
  \maintextfalse
  \vspace{1ex}% XXX: this manual stuff should be done properly!
  \vspace*{1ex}%
  \begin{center}%
  \label{#4}%
  \hypertarget{#4}{}%
  \bibpdfbookmark[1]{#3}{#4}%
  \Huge\begin{hebrew}#1\end{hebrew}%
  \end{center}%
  \vspace*{1ex}%
  \bibmark{book}{#2}%
  \bibmark{oddhead}{#2}%
  \maintexttrue
}

% for book sections: Psalms Book I, Psalms Book II, ...
\newcommand{\tnkhead}[1]{%
  \maintextfalse
  \vspace*{1ex}%
  \begin{center}%
  \LARGE\begin{hebrew}#1\end{hebrew}%
  \end{center}%
  \vspace*{1ex}%
  \bibmark{oddhead}{#1}%
  \maintexttrue
}

\newcommand{\conthead}[1]{\begin{center}\LARGE#1\end{center}}

% to center the last line in massoretic summaries.
\def\tnkcll{%
  \rightskip=\z@\@plus 1fil\relax
  \leftskip=\z@\@plus -1fil\relax
  \parfillskip=\z@\@plus 2fil\relax
  \par
}

\newlength\indentation
\setlength\indentation{2em}

\newcommand{\csec}{\leavevmode \unskip% no preceding space
   \linebreak[1]% prefer break at beginning
   \mbox{ \ \ }\nolinebreak[1]% first 3
   \mbox{ }\nolinebreak[1]\mbox{ }\nolinebreak[1]\mbox{ }\nolinebreak[1]\mbox{ }\nolinebreak[1]\mbox{ }% 5 more
   \mbox{ }\nolinebreak[1]\mbox{ }\nolinebreak[1]\mbox{ }\nolinebreak[1]\mbox{ }\nolinebreak[1]\mbox{ }% 5 more
   \mbox{ }\nolinebreak[1]\mbox{ }\nolinebreak[1]\mbox{ }\nolinebreak[1]\mbox{ }\nolinebreak[1]\mbox{ }% 5 more
   \nolinebreak[1]\mbox{ \ \ }% last 3
   \linebreak[1]%  prefer break at end
   \hspace{-\indentation}\mbox{}\nolinebreak\hspace{\indentation}% optional indentation
   \ignorespaces}

\newcommand*{\osec}{\csec\hfill}
\newcommand*{\csecshort}{%
\mbox{} \mbox{} \mbox{} \mbox{} \mbox{} \mbox{} \mbox{} \mbox{}%
}

\newcommand{\csecp}{\csec}
\newcommand{\probel}{\hspace*{3ex}}
\newcommand{\sprobel}{\hspace*{1.6ex}}
\newcommand{\shirfmt}{\hspace{4ex}}
\newcommand{\hstwocol}{\hspace{20ex}}
\newcommand{\twocolbox}[1]{\makebox[0.5\linewidth][l]{#1}}
\let\m\ensuremath

% for Massoretic summaries at the end of each book.
\newenvironment{summary}{%
  \begin{center}\bibseprule\\*[2ex]\end{center}
  \vspace{2ex}%
  \small\nodiacriticsfalse\maintextfalse
}{%
  \par
}

% Hebrew footnotes have a rule on the right side.
\iflrfn\else
   \renewcommand{\footnoterule}{\hfill\rule{0.26\linewidth}{0.1mm}\vspace{1.5mm}}
\fi

\def\Hsafemacros{%
  \def\begin{\protect\begin}%
  \def\end{\protect\end}%
  \def\Hword{\protect\Hword}%
  \def\Hc{\protect\Hc}%
  \def\Hcl{\protect\Hcl}%
  \def\Hcu{\protect\Hcu}%
  \def\Hmaqqeph{\protect\Hmaqqeph}%
  \maintextfalse
}

\ifbigfoot\else
% redefinition of macros from the footmisc package:
  \long\def\makefootnoteparagraph{\unvbox\footins \makehboxofhboxes
    \setbox\FN@tempboxa=\hbox{\unhbox\FN@tempboxa \removehboxes}
    \hsize\textwidth
    \@parboxrestore
    \baselineskip=\footnotebaselineskip
    \noindent
    \rule{\z@}{\footnotesep}%
    \iflrfn\else\beginR\fi\unhbox\FN@tempboxa\par\iflrfn\else\endR\fi% Tigran added begin/endR
  }
  \long\def\@makefntext#1{\leavevmode
    \@makefnmark\nobreak
    #1% removed \hskip.5em\relax before #1
  }
\fi
\else % non-Hebrew footnotes also should have no indentation.
\ifbigfoot\else
   \long\def\makefootnoteparagraph{\unvbox\footins \makehboxofhboxes
    \setbox\FN@tempboxa=\hbox{\unhbox\FN@tempboxa \removehboxes}
    \hsize\textwidth
    \@parboxrestore
    \baselineskip=\footnotebaselineskip
    \noindent
    \rule{\z@}{\footnotesep}%
    \unhbox\FN@tempboxa\par
  }
  \long\def\@makefntext#1{\leavevmode
    \@makefnmark\nobreak
    #1% removed \hskip.5em\relax before #1
  }
\fi% else of \ifbigfoot
\fi% hebrew

\ifarmenian
\ifxetex
%\setmainfont[Mapping=tex-text]{Newton}
% accents are actually used in the hyphenation exceptions
\lccode`\^^^^055a=`\^^^^055a
\lccode`\^^^^055b=`\^^^^055b
\lccode`\^^^^055c=`\^^^^055c
%\lccode`\^^^^055d=`\^^^^055d % armenian comma - always occurs at the end of word - so no need for it to be present in the hyphenation?
\lccode`\^^^^055e=`\^^^^055e
% undo some definitions from xunicode
% to fix the Missing character errors in typical armenian fonts
\expandafter\let\csname EU1\string\.\endcsname\relax
\expandafter\let\csname EU1\string\'\endcsname\relax
\expandafter\let\csname EU1\string\~\endcsname\relax
\expandafter\let\csname EU1\string\textreferencemark\endcsname\relax
\input{xuni-arm}
\else
\RequirePackage[utf8]{inputenc}
\RequirePackage[OT6]{fontenc}
\input{ot6defs}
%\@namedef{OT6+cmr}{\hyphenchar\font=123 }
%\@namedef{OT6+cmss}{\hyphenchar\font=123 }
% accents are actually used in the hyphenation exceptions
\lccode`\'=`\'
%\lccode`\`=`\`
\lccode`\|=`\|
\lccode`\!=`\!
\lccode`\?=`\?
\lccode32=32
\fi
% for xetex we need at least "ev" pair in \@uclclist,
% but other letters are useful in case macros for other letters are used
\input{uclclist-arm}
\let\l@armenian\l@nohyphenation
\providehyphenmins{armenian}{\tw@\tw@}
\ifgreek\else
\RequirePackage[british]{babel}
\fi
\renewcommand{\bibfnvsmark}{}
\renewcommand{\footnotesize}{\small}
\renewcommand{\bibfnchapsize}{\bfseries\normalsize}
\renewcommand{\bibfnvssize}{\bfseries\small}
\renewcommand{\bibheadfont}{\large}
\renewcommand{\bibheadchapsize}{\normalfont\large}
\renewcommand{\bibheadversesize}{\normalfont\normalsize}
\renewcommand{\bibpage}{\armeh\armjheh}
\renewcommand{\bibchapname}{\ARMGIM\armliwn\armvo\armyiwn\armxeh}
\renewcommand{\bibpsalmname}{\ARMSEH\armayb\armghad\armmen\armvo\armseh}
\renewcommand{\bibcontname}{\ARMCO\armayb\armnow\armken}
\renewcommand{\bibtocfont}{\fontsize{12}{15}\selectfont}
\renewcommand{\bibtocheadfont}{\Large\scshape}
\fi% of \ifarmenian

\ifromanian
\RequirePackage[latin2]{inputenc}
\RequirePackage{newcent}
\RequirePackage[T1]{fontenc}
\RequirePackage[romanian,british]{babel}
\fi

\ifgerman
\RequirePackage[latin1]{inputenc}
\RequirePackage{newcent}
\RequirePackage[T1]{fontenc}
\RequirePackage[german,british]{babel}
\fi

\ifswedish
\RequirePackage[latin1]{inputenc}
\RequirePackage{newcent}
\RequirePackage[T1]{fontenc}
\RequirePackage[swedish,british]{babel}
\renewcommand{\bibpsalmname}{Psalmen}
\fi

\iffrench
\RequirePackage[latin1]{inputenc}
\RequirePackage{newcent}
\RequirePackage[T1]{fontenc}
\RequirePackage[french,british]{babel}
\renewcommand{\bibpsalmname}{Psaume}
\fi

\ifpolish
\RequirePackage[latin2]{inputenc}
\RequirePackage{lmodern}
\RequirePackage[T1]{fontenc}
\RequirePackage[polish,british]{babel}
\fi

\ifhungarian
\RequirePackage[latin2]{inputenc}
\RequirePackage{newcent}
\RequirePackage[T1]{fontenc}
\RequirePackage[hungarian,british]{babel}
\fi

\ifdutch
\RequirePackage[latin1]{inputenc}
\RequirePackage{newcent}
\RequirePackage[T1]{fontenc}
\RequirePackage[dutch,british]{babel}
\fi

\ifitalian
\RequirePackage[latin1]{inputenc}
\RequirePackage{lmodern}
\RequirePackage[T1]{fontenc}
\RequirePackage[italian,british]{babel}
\fi

\ifspanish
\RequirePackage[latin1]{inputenc}
\RequirePackage{newcent}
\RequirePackage[T1]{fontenc}
\RequirePackage[spanish,british]{babel}
\renewcommand{\bibpsalmname}{Salmo}
\renewcommand{\bibtitlefont}{\Huge\scshape}
\fi

\ifportuguese
\RequirePackage[latin1]{inputenc}
\RequirePackage{lmodern}
\RequirePackage[T1]{fontenc}
\RequirePackage[portuguese,british]{babel}
\fi

\iflatin
\RequirePackage[latin,british]{babel}
\RequirePackage{palatino}
\renewcommand{\bibtocfont}{\normalsize}
\fi

\ifenglish
\RequirePackage[british]{babel}
\RequirePackage{newcent}
\renewcommand{\bibnotelang}[1]{\textlatin{#1}}
\fi

\ifsyriac
\ifhebrew\else
\RequirePackage[british]{babel}
\fi
\RequirePackage{serto}
\newcommand{\syrpar}{\hspace*{2pt}\textreferencemark\hspace*{2pt}}
\fi

\ifukrainian
\RequirePackage[koi8-u]{inputenc}
\RequirePackage{literat}
\RequirePackage[T2A]{fontenc}
\RequirePackage[ukrainian,british]{babel}
\renewcommand{\bibpage}{\CYRS\cyrt\cyrr.}
\renewcommand{\bibchapname}{Chapter}
\renewcommand{\bibcontname}{Contents}
\fi

\ifslavonic
\RequirePackage[utf8]{inputenc}
\RequirePackage[T2A,T1]{fontenc}
\RequirePackage{cslav}
\cslfont{starouspenskaya}
\renewcommand{\bibpage}{\textcsl{\CYRS\cyrt\cyrr.}}
\renewcommand{\bibchapname}{\textcsl{\CYRG\cyrl\cyra\cyrv\cyra}}
\renewcommand{\bibfnvsmark}{}
\newcommand{\fncsl}[1]{\ts{\normalfont *}\fn{\textcsl{\small#1}}}
\newcommand{\fntcsl}[1]{\fnt{\textcsl{\small#1}}}
\fi

\ifrussian
\ifxetex
\RequirePackage{polyglossia,tabularx,multirow,lscape}
\setdefaultlanguage{russian}
\newcommand{\textlatin}[1]{{#1}}
\newcommand\vsfmt[3]{\bk{#1}\nobreakspace#2:#3}
\renewcommand{\bibpage}{Стр.}
\else
   \defaulthyphenchar=127
   \lccode`\-=`\-
   \RequirePackage[koi8-r]{inputenc}
   \RequirePackage{cmap}
   \IfFileExists{octava.sty}{\RequirePackage{octava}}{\RequirePackage{literat}}
   \RequirePackage[T2A]{fontenc}
   \RequirePackage[russian,british]{babel}
   \RequirePackage{tabularx,multirow,lscape}
   \renewcommand{\bibpsalmname}{\CYRP\cyrs\cyra\cyrl\cyro\cyrm}
   \renewcommand{\bibpage}{\CYRS\cyrt\cyrr.}
   \renewcommand{\bibchapname}{\CYRG\cyrl\cyra\cyrv\cyra}
   \renewcommand{\bibcontname}{\CYRO\cyrg\cyrl\cyra\cyrv\cyrl\cyre\cyrn\cyri\cyre}
   \newcommand\vsfmt[3]{\bk{#1}\nobreakspace#2:#3}
\fi
% temporary definitions for russian vowels with acute (for \acc macro),
% to be removed when hyperref adds generic translation of TeX accents to Unicode combining accents
\DeclareTextCompositeCommand{\'}{PU}{\CYRA}{\84\020\83\001}
\DeclareTextCompositeCommand{\'}{PU}{\CYRE}{\84\025\83\001}
\DeclareTextCompositeCommand{\'}{PU}{\CYRI}{\84\030\83\001}
\DeclareTextCompositeCommand{\'}{PU}{\CYRO}{\84\036\83\001}
\DeclareTextCompositeCommand{\'}{PU}{\CYRU}{\84\043\83\001}
\DeclareTextCompositeCommand{\'}{PU}{\CYRERY}{\84\053\83\001}
\DeclareTextCompositeCommand{\'}{PU}{\CYREREV}{\84\055\83\001}
\DeclareTextCompositeCommand{\'}{PU}{\CYRYU}{\84\056\83\001}
\DeclareTextCompositeCommand{\'}{PU}{\CYRYA}{\84\057\83\001}
\DeclareTextCompositeCommand{\'}{PU}{\cyra}{\84\060\83\001}
\DeclareTextCompositeCommand{\'}{PU}{\cyre}{\84\065\83\001}
\DeclareTextCompositeCommand{\'}{PU}{\cyri}{\84\070\83\001}
\DeclareTextCompositeCommand{\'}{PU}{\cyro}{\84\076\83\001}
\DeclareTextCompositeCommand{\'}{PU}{\cyru}{\84\103\83\001}
\DeclareTextCompositeCommand{\'}{PU}{\cyrery}{\84\113\83\001}
\DeclareTextCompositeCommand{\'}{PU}{\cyrerev}{\84\115\83\001}
\DeclareTextCompositeCommand{\'}{PU}{\cyryu}{\84\116\83\001}
\DeclareTextCompositeCommand{\'}{PU}{\cyrya}{\84\117\83\001}
\fi

\ifcoptic
\long\def\g@prependto@macro#1#2{%
  \begingroup
    \toks@\expandafter{#1}%
    \xdef#1{\unexpanded{#2}\the\toks@}%
  \endgroup}
\RequirePackage[british]{babel}
\RequirePackage{coptic}
\RequirePackage{palatino}
% increase the default inter-word spacing
\@namedef{LCOP+coptic}{\fontdimen2\font=1.5\fontdimen2\font\relax}
\renewcommand{\bibtitlefont}{\LARGE}
\renewcommand{\bibpage}{\textlatin{Page}}
\g@prependto@macro{\bibmarnchfont}{\fontencoding{T1}\fontfamily{cmr}\selectfont}
\g@prependto@macro{\bibmarnvsfont}{\fontencoding{T1}\fontfamily{cmr}\selectfont}
\renewcommand{\bibheadfont}{\normalsize\setcopto}
\AtEndOfPackage{\def\mpr@comma{\unskip\te{,}\space}}
\fi

\ifswahili
\RequirePackage[british]{babel}
\RequirePackage{newcent}
\renewcommand{\bibnotelang}[1]{\textlatin{#1}}
\renewcommand{\bibchapname}{Sura ya} %'mlango'?
\renewcommand{\bibcontname}{Fahirisi}
\renewcommand{\bibpsalmname}{Zaburi}
\fi

\ifbulgarian
\ifxetex
\RequirePackage{polyglossia}
\RequirePackage[bulgarian]{babel}
\setotherlanguage[variant=poly]{greek}
\else
\defaulthyphenchar=127
\lccode`\-=`\-
\RequirePackage[koi8-r]{inputenc}
\IfFileExists{octava.sty}{\RequirePackage{octava}}{\RequirePackage{literat}}
\RequirePackage[T2A]{fontenc}
\RequirePackage[bulgarian,british]{babel}
\renewcommand{\bibpage}{\CYRS\cyrt\cyrr.}
\renewcommand{\bibchapname}{Chapter}
\renewcommand{\bibcontname}{Contents}
\fi
\fi

\newlength\fnsymskip
\setlength\fnsymskip{2pt}

\font\ygoth=ygoth
\font\yfrak=yfrak
\font\yswab=yswab
\font\bgfrak=yfrak at 12pt
\font\smfrak=yfrak at 8pt

\declarebibsrc{LXX}{{\yfrak G}}
\declarebibsrc{Aquila}{$\alpha'$}
\declarebibsrc{Symmach}{$\sigma'$}
\declarebibsrc{Theod}{$\theta'$}
\declarebibsrc{Syr}{{\yfrak S}}
\declarebibsrc{Eth}{{\yfrak E}}
\declarebibsrc{Sah}{{\yfrak C}}
\declarebibsrc{Boh}{{\yfrak B}}
\declarebibsrc{Tg}{{\yfrak T}}
\declarebibsrc{Vg}{{\ygoth V}}
\declarebibsrc{VL}{{\ygoth L}}
\declarebibsrc{Lat}{{\ygoth L}}
\declarebibsrc{MT}{{\ygoth M}}
\declarebibsrc{Qum}{{\ygoth Q}}
\declarebibsrc{SP}{{\ygoth S}}
\declarebibsrc{Arm}{{\ygoth A}}
\declarebibsrc{Arab}{{\yfrak A}}
\declarebibsrc{Boh}{{\yfrak B}}
\declarebibsrc{Geo}{{\ygoth G}}
\declarebibsrc{Slav}{{\yfrak R}}
\declarebibsrc{Ostr}{{\yswab O}}
\declarebibsrc{Clem}{{\ygoth cl}}
\declarebibsrc{Complut}{{\ygoth c}}
\declarebibsrc{Walton}{{\ygoth W}}
\declarebibsrc{benChayim}{{\ygoth B}}
\declarebibsrc{Inscr.}{\textlatin{\small\slshape Inscr.}}
\declarebibsrc{Jub}{{\ygoth J}}
\declarebibsrc{Maj}{{\smfrak M}}
\declarebibsrc{ms}{\textlatin{\small\slshape ms}}
\declarebibsrc{mss}{\textlatin{\small\slshape mss}}
\declarebibsrc{pr}{\textlatin{\small\slshape pr}}

\ifgreek
\ifxetex
\RequirePackage{polyglossia}
\setdefaultlanguage[variant=poly]{greek}
\else
\RequirePackage[greek,british]{babel}
\languageattribute{greek}{polutoniko}
% in case of latin text, use T1 rather than OT1 which is broken in kerkis:
\RequirePackage[T1]{fontenc}
\RequirePackage{kerkis,textcomp}
\DeclareFontSubstitution{LGR}{mak}{m}{n}
\newcommand{\gram}[1]{\textsuperscript{\textlatin{#1}}}
\renewcommand{\bibnotelang}[1]{\textgreek{#1}}
\newcommand{\myfrak}{} % manipulated in tex/intro.tex
\font\bbbig=msbm10
\font\bbsmall=msbm7 at 7.1pt
\newcommand{\bbfont}{} % manipulated in tex/intro.tex

% declare sources with non-default appearance
\declarebibsrc{T}{{\bbfont T}}
\declarebibsrc{M}{{\bbfont M}}
\declarebibsrc{K}{{\bbfont K}}
\declarebibsrc{V}{{\bbfont V}}
\declarebibsrc{N}{{\bbfont N}}
\declarebibsrc{TMK}{{\bbfont T\ts{*}}}
\declarebibsrc{TMKVN}{{\bbfont E}}
\declarebibsrc{D05}{\te{D}}
\declarebibsrc{d05}{\te{d}}
\declarebibsrc{D06}{\te{D}}
\declarebibsrc{E07}{\te{E}}
\declarebibsrc{E08}{\te{E}}
\declarebibsrc{E09}{\te{E}}
\declarebibsrc{F09}{\te{F}}
\declarebibsrc{F010}{\te{F}}
\declarebibsrc{G011}{\te{G}}
\declarebibsrc{G012}{\te{G}}
\declarebibsrc{H013}{\te{H}}
\declarebibsrc{H014}{\te{H}}
\declarebibsrc{H015}{\te{H}}
\declarebibsrc{K017}{\te{K}}
\declarebibsrc{K018}{\te{K}}
\declarebibsrc{L019}{\te{L}}
\declarebibsrc{L020}{\te{L}}
\declarebibsrc{M021}{\te{M}}
\declarebibsrc{N022}{\te{N}}
\declarebibsrc{O023}{\te{O}}
\declarebibsrc{P024}{\te{P}}
\declarebibsrc{P025}{\te{P}}
\declarebibsrc{Q026}{\te{Q}}
\declarebibsrc{R027}{\te{R}}
\declarebibsrc{S028}{\te{S}}
\declarebibsrc{T029}{\te{T}}
\declarebibsrc{U030}{\te{U}}
\declarebibsrc{V031}{\te{V}}
\declarebibsrc{X033}{\te{X}}
\declarebibsrc{Y034}{\te{Y}}
\declarebibsrc{Z035}{\te{Z}}
\declarebibsrc{pc}{\te{\textsl{pc}}}
\declarebibsrc{(pc)}{\te{\textsl{(pc)}}}
\declarebibsrc{al}{\te{\textsl{al}}}
\declarebibsrc{pm}{\te{\textsl{pm}}}
\declarebibsrc{rell}{\te{\textsl{rell}}}
\declarebibsrc{aleph}{$\aleph$}
\declarebibsrc{(aleph)}{($\aleph$)}
%\declarebibsrc{aleph}{\begin{hebrew}'\end{hebrew}}
%\declarebibsrc{(aleph)}{(\begin{hebrew}'\end{hebrew})}
\declarebibsrc{Gamma}{\textgreek{G}}
\declarebibsrc{Delta}{\textgreek{D}}
\declarebibsrc{Theta}{\textgreek{J}}
\declarebibsrc{Lambda}{\textgreek{L}}
\declarebibsrc{Ksi}{\textgreek{X}}
\declarebibsrc{Pi}{\textgreek{P}}
\declarebibsrc{Sigma}{\textgreek{S}}
\declarebibsrc{Phi}{\textgreek{F}}
\declarebibsrc{Psi}{\textgreek{Y}}
\declarebibsrc{Omega}{\textgreek{W}}
\declarebibsrc{Pap}{{\smfrak P}}

\newcount\lect
\lect=1
\loop
\ifnum\lect<3000
  \edef\temp@src{{l\number\lect}{\unexpanded{\ensuremath{\ell}}\number\lect}}
  \expandafter\declarebibsrc\temp@src
\advance\lect by1
\repeat

\DeclareTextCommand{\stigma}{LGR}{\char6\relax}
\def\gkabb#1{$\overline{\mbox{\textgreek{#1}}}$}
\def\gknum#1{$\overline{\mbox{\textgreek{\itshape #1}}}$}
\def\z{\gknum{z}}
\def\ib{\gknum{i{}b}}
\def\id{\gknum{i{}d}}
\def\rmd{\gknum{\noboundary rmd}}
\def\qxc{\gknum{qx\stigma}}
\renewcommand{\bibpage}{\textlatin{Page}}
\renewcommand{\bibchapname}{Chapter}
% babel's definition doesn't switch on the \extras...
% which are needed for e.g. polutoniko greek, so we redefine it
\def\textgreek{\foreignlanguage{greek}}

% babel defines \uccode for accents in polutonico greek in such a way
% that they disappear; so do not use uppercase for lettrine in greek
\def\process@lettrine#1{#1}

% \noboundary ensures that if there are initial letter forms
% selected via boundary-char ligatures, they will not be used
% after a letter with \r accent
\DeclareTextCommand{\r}{LGR}[1]{\UseTextAccent{OT1}{\r}{\test@gk@bcl{#1}}\noboundary}
\def\test@gk@bcl#1{\@ifundefined{gk@bcl@#1}{#1}{\@nameuse{gk@bcl@#1}}}
\@ifpackageloaded{kerkis}{%
% treat specially \r{vr} etc for kerkis fonts
  \def\gk@bcl@vr{\char20\relax}%
  \def\gk@bcl@vf{\char15\relax}%
  \def\gk@bcl@vz{\char13\relax}%
  \def\gk@bcl@vj{\char12\relax}%
  \def\gk@bcl@vb{\char16\relax}%
}{%
  \def\gk@bcl@vr{r}%
  \def\gk@bcl@vf{f}%
  \def\gk@bcl@vz{z}%
  \def\gk@bcl@vj{j}%
  \def\gk@bcl@vb{b}%
}
\fi % \else of \ifxetex
\fi

\ifdropcaps
\RequirePackage{yfonts}
\fi

\iflettrine
\RequirePackage{lettrine}
\setcounter{DefaultLines}{3}
\fi

\newif\if@lettrine@or@dropcaps
\iflettrine\@lettrine@or@dropcapstrue\fi
\ifdropcaps\@lettrine@or@dropcapstrue\fi

\def\incnote#1{\input{tex/note-\bkname-\thechnum-\curr@vs-#1}}

\def\bibchap{%
  \ifhebrew
    \ifnomarnvs\else\bibrevmarn{\mpr@ch{\bkname}{\thechnum}}\fi%
  \else
    %\ifnomarnvs\if@firstvs@bk\else\lettrine[loversize=0.3,lraise=0.2]{\textlatin{\bfseries\thechnum}}{ }\fi\else\bibmarn{\mpr@ch{\bkname}{\thechnum}}\fi%
    \ifnomarnvs\noindent\textlatin{\Large\bfseries\upshape\thechnum}\space\else\bibmarn{\mpr@ch{\bkname}{\thechnum}}\fi%
  \fi
}

\ifnohyperref
\def\hyperlink#1#2{#2}
\def\hypertarget#1#2{#2}
\def\bib@raise@anchor#1{}
\def\acc#1{\'{#1}}
\protected\def\mpr@ch#1#2{%
  \ifhebrew
    \bibmarnchfont\hebrewnum{#2}%
  \else
    \bibmarnchfont\ifromanchap\@Roman{#2}\else#2\fi
  \fi
}
\newcommand*{\bibmetadata}[5]{}
\newcommand*{\bibpr}[1]{\textlatin{\pageref{#1}}}
\newcommand*{\bibpdfbookmark}[3][0]{}
% FIXME these \selectlanguage should be changed to \textlatin
\newcommand*{\biburl}[1]{{\selectlanguage{british}\normalsize\upshape #1}}
\newcommand*{\biblesorguk}{\selectlanguage{british}\Large\upshape Bibles.org.uk, London.}
\newcommand*{\bibht}{}
\newcommand*{\bibhl}[2]{#2}
\newcommand*{\rref}[3]{#1\nobreakspace#2.#3}
\newcommand*{\lref}[3]{#1\nobreakspace#2.#3}
\newcommand*{\href}[2]{#2}
\newcommand*{\bibpdfdest}[1]{}
\else
\RequirePackage[\ifxetex\else unicode,\fi plainpages=false,hyperfootnotes=false,pdfpagelabels,
colorlinks,
linkcolor=black,
anchorcolor=black,
citecolor=black,
filecolor=black,
menucolor=black,
pagecolor=black,
urlcolor=black
]{hyperref}
\ifarmenian\ifxetex\else\@input{puarm.tex}\fi\fi
\ifembedsrc
\RequirePackage{attachfile}[2006/03/28]
% earlier version has a bug with mimetype handling
\attachfilesetup{%
  mimetype={text/plain},%
  print={false},%
  author={Bibles.org.uk - http://www.bibles.org.uk},%
  timezone={Z}% Z means GMT.
}
\fi
\protected\def\mpr@ch#1#2{%
  \ifhebrew
    \href{run:mp3/\jobname/#1/#1#2.mp3}{\bibmarnchfont\hebrewnum{#2}}%
  \else
    \href{run:mp3/\jobname/#1/#1#2.mp3}{\bibmarnchfont\ifromanchap\@Roman{#2}\else#2\fi}%
  \fi
}
\newcommand*{\bibmetadata}[5]{% metadata stored in the PDF file.
\ifembedsrc\attachfilesetup{subject={#2}}\fi
\AtBeginDocument{%
\hypersetup{%
  pdftitle={#1},%
  pdfauthor={Bibles.org.uk - http://www.bibles.org.uk},%
  pdfsubject={#2},%
  pdfkeywords={#3},%
  pdflang={#5},%
  pdfcreationdate={D:#4Z},%
  pdfmoddate={D:\pdfdate-00'00'},%
  baseurl={http://www.bibles.org.uk}%
}%
\ifxetex
  \hypersetup{pdfcreator={XeLaTeX of TeX Live 2016}}%
\else
  \hypersetup{pdfcreator={pdfLaTeX of TeX Live 2016}}%
\fi
\ifpmnone\hypersetup{pdfpagemode={UseNone}}\fi
\ifbindrtol\hypersetup{pdfdirection={R2L}}\fi
}%
}

\protected\def\bib@raise@anchor#1{%
  \ifhmode
    \iftrue
      \Hy@raisedlink{#1}%
    \else
      \vadjust pre{%
        %\smash{#1}%
        \@ovri\dp\strutbox \kern-\@ovri
        \setbox\z@\hb@xt@\hsize{#1}%
        \ht\z@\z@ \dp\z@\@ovri \box\z@
        \kern\z@
      }%
    \fi
  \else#1\fi
}

\newcommand*{\bibpr}[1]{\hyperlink{#1}{\textlatin{\pageref*{#1}}}}
\newcommand*{\bibpdfbookmark}[3][0]{\pdfbookmark[#1]{#2}{#3}}
\newcommand*{\rref}[3]{\href{tnk.pdf\##1#2_#3}{#1\nobreakspace#2.#3}}
\newcommand*{\lref}[3]{\hyperlink{#1#2_#3}{#1\nobreakspace#2.#3}}
\newcommand*{\bibht}{%
  \bib@raise@anchor{\hypertarget{\bkname\thechnum_\curr@vs}{}}%
  \nobreak\hskip\z@skip
}
\newcommand*{\bibhl}[2]{\hyperlink{#1}{#2}}
% FIXME these \selectlanguage should be changed to \textlatin
\newcommand*{\biburl}[1]{{\selectlanguage{british}\normalsize\upshape\url{#1}}}
\newcommand*{\biblesorguk}{\selectlanguage{british}\href{http://www.bibles.org.uk/}{\Large\upshape Bibles.org.uk, London.}}
\newcommand*{\bibpdfdest}[1]{\pdfdest name {#1} fit}

% \acc macro to print vowel with acute
% note that the generated PDF will rely on the "Replacement Text" feature in PDF 1.5
% so one needs to specify \pdfminorversion=5 is such \acc macro is used.
%\RequirePackage{accsupp} % XXX re-enable when TeX Live is upgraded!
%\def\acc#1{\BeginAccSupp{method=pdfstringdef,unicode,ActualText={\'{#1}}}\'{#1}\EndAccSupp{}}
\DeclareTextCommand{\combacute}{PU}{\83\001}
%\def\acc#1{\BeginAccSupp{method=pdfstringdef,unicode,ActualText={#1\combacute}}\'{#1}\EndAccSupp{}} % XXX re-enable when TeX Live is upgraded!
% we used the above definition to allow copying from PDF to work properly,
% instead of the following simplified definition:
\def\acc#1{\'{#1}}
\fi

\def\bk#1{\@ifundefined{bibbooks@#1@abbr}{#1}{\@nameuse{bibbooks@#1@abbr}}}
\def\bibref{\@ifnextchar[{\bibref@c}{\bibref@a}}
\def\bibref@a#1{\bibref@b#1\relax}
\def\bibref@b#1 #2:#3\relax{\bibref@c[\vsfmt{#1}{#2}{#3}]{#1 #2:#3}}
\def\bibref@c[#1]#2{%
  \immediate\write\@mainaux{\string\need@ht{#2}}%
  \bibref@d{#1}#2\relax
}
\def\bibref@d#1#2 #3:#4\relax{\hyperlink{#2#3_#4}{#1}}
\def\need@ht#1{\need@ht@a#1\relax}
\def\need@ht@a#1 #2:#3\relax{\global\@namedef{do@ht@#1@#2@#3}{}}
\providecommand\vsfmt[3]{\bk{#1}\nobreakspace#2.#3}

\setlength\parindent{15\p@}

\newif\if@firstvs@ch
\newif\if@firstvs@bk
\newcounter{chnum}
\newcounter{nnotes}
\newcounter{nvsnotes} % number of footnotes in this verse
\newcounter{numfnt}
\newcounter{numefnt}
\newcounter{numalfnt}
\newcounter{numafnt}
\newcounter{numbfnt}
\newcounter{numcfnt}
\newcounter{numdfnt}
\newcounter{numffnt}
\newcounter{numifnt}
\newcounter{numjfnt}
\newcounter{numlfnt}
\newcounter{numnfnt}
\newcounter{nummajfnt}
\newcounter{numpfnt}
\newcounter{numwfnt}
\newcounter{numarmfnt}
\newcounter{numcofnt}
\newcounter{numgeofnt}
\newcounter{numgotfnt}
\newcounter{numethfnt}
\newcounter{numsyrfnt}
\newcounter{numslafnt}
\newcounter{numitfnt}
\newcounter{numvgfnt}
\newcounter{numlattfnt}

% for Hebrew-only, incremented by \seder and \sederpcr
\newcounter{sedernum}
% for Hebrew-only, incremented by \parasha
\newcounter{parashanum}

\def\treat@colon{%
  \edef\restore@colon{\catcode58=\the\catcode58 \relax}%
  \catcode58=12
}

\newif\if@vs@dc@do
% XXX
\def\vs{\ifparvs\par\fi\treat@colon\@ifnextchar\bgroup\@vs\@@vs}
\def\@vs#1{\@@vs #1 \ignorespaces}
\def\@@vs#1 #2:#3 {%
  \restore@colon
  \@vs@dc@dofalse
  \def\test@bk{#1}%
  \ifx\bkname\test@bk\else\global\@firstvs@chtrue\global\@firstvs@bktrue\fi
  \def\test@ch{#2}%
  \ifx\curr@ch\test@ch\else\global\@firstvs@chtrue\fi
  \if@firstvs@bk
    %\ifnum #2=1
      \if@lettrine@or@dropcaps\@vs@dc@dotrue\fi
    %\fi
  \fi
  \if@firstvs@ch
    \ifnochpar\else
      \par
      \ifhebrew\beginR\fi
      \if@vs@dc@do\else\leavevmode\fi
    \fi
  \else
    \ifhebrew\else\hspace{0.2ex}\fi
  \fi
  \gdef\bkname{#1}%
  \gdef\curr@ch{#2}%
  \gdef\curr@vs{#3}%
  \setcounter{chnum}{#2}%
  \if@vs@dc@do
    \expandafter\vs@test@emph
  \else
    \let\vs@emph\@empty
    \vs@e
    % FIXME review \ignorespaces usage and also use \@firstofone
    % to not loose possible kern when the first letter is enclosed in braces
    \ignorespaces
  \fi
}
\def\vs@test@emph{%
  \@ifnextchar\bibemph{\vs@a}{\vs@b}%
}
\def\vs@a#1#2{% #1 is \bibemph
  \vs@c#2\@nil
  \vs@d
}
\def\vs@c#1#2\@nil{%
  \def\vs@dc{#1}%
  \def\vs@emph{#2}%
  \ifx\vs@emph\@empty
    \let\vs@emph\ignorespaces
  \else
    \def\vs@emph{\bibemph{#2}}%
  \fi
}
\def\vs@b#1{%
  \def\vs@dc{#1}%
  \let\vs@emph\@empty
  \vs@d
}
\def\vs@d{%
  \ifdropcaps
    \yinipar{\textcolor{\bibdropcapscolor}{\process@lettrine{\vs@dc}}}%
  \else
    \iflettrine
      \lettrine{\textcolor{\bibdropcapscolor}{\process@lettrine{\vs@dc}}}{}%
    \fi
  \fi
  \vs@e
}
\def\vs@zero{0}
\def\vs@e{%
  \if@firstvs@ch
    \global\@firstvs@chfalse
    \@ifundefined{deferred@bibpdfbookmark}{}{%
      \deferred@bibpdfbookmark
      \let\deferred@bibpdfbookmark\@undefined
    }%
    \ifchapbookm
     \ifnum\c@chnum>0
       \bib@raise@anchor{\bibpdfbookmark[2]{\bookmarkchname\ \thechnum}{\bkname_\thechnum}}%
     \fi
    \fi
    \setcounter{nnotes}{0}%
    \ifnum\c@chnum>0
      \bibchap
    \fi
    \ifsyriac\else
      \ifvssup
        \if@firstvs@bk\else
          \ifnomarnvs\else\ifx\curr@vs\vs@zero\else\print@vssup{\curr@vs}\fi\fi
        \fi
      \fi
    \fi
    \global\@firstvs@bkfalse
  \else
    \setcounter{nvsnotes}{0}%
    \ifx\curr@vs\vs@zero\else
      \ifchvsrevmarn
        \ifnomarnvs\else\bibrevmarn{\mpr@vs{\bkname}{\curr@ch}{\curr@vs}}\fi%
      \else
        \ifnomarnvs\else\bibmarn{\mpr@vs{\bkname}{\curr@ch}{\curr@vs}}\fi%
      \fi
      \ifvssup
        \print@vssup{\curr@vs}%
      \fi
    \fi
  \fi
  \ifx\curr@vs\vs@zero\else
    \ifvsbookmarks\bib@raise@anchor{\bibpdfbookmark[3]{\bkname\ \thechnum:\curr@vs}{\bkname_\thechnum_\curr@vs}}\fi
    \write@mark{vs}{{\thechnum}{\curr@vs}}%
  \fi
  \ifcsname do@ht@\bkname @\curr@ch @\curr@vs\endcsname\bibht\fi
  \ifxrefs\ifcsname vs@xr@\bkname @\curr@ch @\curr@vs\endcsname\fnxref{\@nameuse{vs@xr@\bkname @\curr@ch @\curr@vs}}\fi\fi
  \nobreak\hskip\z@skip
  \vs@emph
}
\protected\def\mpr@vs#1#2#3{\bibmarnvsfont #3}
\protected\def\print@vssup#1{\@textsuperscript{\latintext\fontsize{6}{7}\selectfont#1}\kern0.1em\relax}
\protected\def\printvssup#1{\print@vssup{#1}}
\ifvsbookmarks\advance\Hy@bookmarksdepth\@ne\fi % maybe we should set \Hy@bookmarksdepth unconditionally to some high value?

% override the default chapter name shown in bookmarks, for specific books
\@namedef{bib@bm@ch@Psa}{\bibpsalmname}
\@namedef{bib@bm@ch@Pss}{\bibpsalmname}
%\def\bookmarkchname{\bkname} % convenient default for eBook readers
% other choices:
% previous default - \bibchapname with special name for Psa, Pss:
\def\bookmarkchname{\@ifundefined{bib@bm@ch@\bkname}{\bibchapname}{\@nameuse{bib@bm@ch@\bkname}}}

\def\bibchaplabel#1{%
   \bibheadchapsize
   \ifnum #1=0
     0%
   \else
     \ifromanchap\@Roman{#1}\else#1\fi
   \fi
}

\def\vs@range{%
  \@ifundefined{mark@vs@\thepage}{}{%
    \expandafter\expandafter\expandafter
      \vs@range@a\csname mark@vs@\thepage\endcsname
  }%
}
\def\vs@range@a#1#2#3#4{\vs@range@b#2#4}
\def\vs@range@b#1#2#3#4{%
  \ifnum #1=#3
    \def\vs@temp@a{#2}%
    \def\vs@temp@b{#4}%
    \ifx\vs@temp@a\vs@temp@b
      {\bibchaplabel{#1}.}{\bibheadversesize#2}%
    \else
      {\bibchaplabel{#1}.}{\bibheadversesize#2--#4}%
    \fi
  \else
    {\bibchaplabel{#1}.}{\bibheadversesize#2--\bibchaplabel{#3}.\bibheadversesize#4}%
  \fi
}

% use eTeX's extended marks for fancy headers
\def\bibnewmark#1{\expandafter\newmarks\csname bibmark@#1\endcsname}
\def\bibmark#1#2{%
  \@temptokena{#2}%
  \expandafter\marks\csname bibmark@#1\endcsname{\the\@temptokena}%
  \if@nobreak\ifvmode\nobreak\fi\fi
}
\def\bibtopmark#1{\expandafter\topmarks\csname bibmark@#1\endcsname}
\def\bibfirstmark#1{\expandafter\firstmarks\csname bibmark@#1\endcsname}
\def\bibbotmark#1{\expandafter\botmarks\csname bibmark@#1\endcsname}

\bibnewmark{book}

\ifhebrew
\bibnewmark{oddhead} % parashah names or Psalms Books
\iflrfn
\fancyhead[LE,RO]{\bibheadfont\vs@range}
\fancyhead[LO,RE]{\bibheadpagesize\thepage}
\else
\fancyhead[LO,RE]{\bibheadfont\vs@range}
\fancyhead[LE,RO]{\bibheadpagesize\thepage}
\fi
\fancyhead[CO]{\bibheadfont\begin{hebrew}\maintextfalse\bibbotmark{oddhead}\end{hebrew}}
\fancyhead[CE]{\bibheadfont\begin{hebrew}\maintextfalse\bibfirstmark{book}\end{hebrew}}
\else
\fancyhead[LE,RO]{\bibheadfont\vs@range}
\fancyhead[LO,RE]{\bibheadpagesize\textlatin{\thepage}}
\fancyhead[C]{\bibheadfont\bibfirstmark{book}}
\fi
\fancyfoot{}

\newcommand{\outerpgnum}{%
  \fancyhead[LO,RE]{}
  \fancyhead[LE,RO]{\bibheadpagesize\textlatin{\thepage}}
}

\newcommand{\innerpgnum}{%
  \fancyhead[LE,RO]{\vs@range}
  \fancyhead[LO,RE]{\bibheadpagesize\textlatin{\thepage}}
}

\newcommand{\clp}{\clearpage{\pagestyle{empty}\cleardoublepage}}

\ifkeepfnmark\else
  \def\@makefnmark{}
\fi

% for use in "tabulary" material (e.g. in intro.pdf)
\newcommand{\bibtabhline}{\rule[-2mm]{0mm}{6mm}\itshape\normalsize}
\newcommand{\stru}{\rule[-1.2mm]{0mm}{4mm}}
\newcommand{\bcs}{\scriptsize\centering\stru}

% general purpose macros
\newcommand{\bibvsend}{%
   \begingroup
     \kern0.5ex\fontsize{4}{4}\selectfont\ding{71}
   \endgroup
}

\def\bibdf{\leaders\hbox to 0.7em{\hss.\hss}\hfill}
\DeclareTextCommandDefault{\textellipsis}{.\kern\fontdimen3\font.\kern\fontdimen3\font.} % corrected \textellipsis
\newcommand*{\bibemph}[1]{\emph{#1}}
\newcommand*{\bibpsahead}[1]{\textsc{#1}\\}
\newcommand{\ts}[1]{\textsuperscript{#1}}
\newcommand{\tb}[1]{\textsubscript{#1}}
\newcommand*{\bt}[1]{\textbf{#1}}
\newcommand{\bibtheend}[1]{\begingroup\vfill\begin{center}\maintextfalse\small#1\end{center}\null\vfill\endgroup}
\def\overprint#1#2{\setbox\z@\hbox{#1}\rlap{\hb@xt@\wd\z@{\hss#2\hss}}#1}
\def\backslashed#1{\overprint{#1}{\textbackslash}}
\def\chhdr#1{\begin{center}\bibemph{#1}\end{center}}

% pre-title page
\newcommand{\bibpretitle}[1]{%
  \thispagestyle{empty}%
  \begingroup
  \font\largegoth=ygoth at 30pt
  \vspace*{\stretch{0.3}}%
  \begin{center}\largegoth #1\end{center}%
  \vspace*{\stretch{0.7}}%
  \endgroup
  \clp
}

\def\bibseprule{%
  \rule{0.1\linewidth}{0.5pt}%
  \kern-0.5pt%
  \lower2.3pt
    \hbox{\scriptsize\ding{71}}%
  \kern-0.7pt%
  \rule{0.1\linewidth}{0.5pt}%
}

\newcommand{\bibbook}[4]{%
  \@ifnextchar[{\@bibbook{#1}{#2}{#3}{#4}}{\@bibbook{#1}{#2}{#3}{#4}[#3]}%
}

%\def\bk@iiijohn{3Jo}
%\def\bkn{#4}
%\ifx\bkn\bk@iiijohn\vspace*{1cm}\else\newpage\fi\thispagestyle{empty}%

\newlength{\bibtitlepreskip}
\newlength{\bibtitlepostskip}
\setlength{\bibtitlepreskip}{2ex}
\setlength{\bibtitlepostskip}{1ex}

\def\@ubook#1#2#3#4[#5]{%
  % #1 title to go on the first page.
  % #2 title to go into the heading.
  % #3 title to go in the PDF bookmark.
  % #4 anchor for references.
  % #5 optional TOC entry, if absent then #3 (bookmark name) is used.
  \label{#4}\hypertarget{#4}{}%
  \bibpdfbookmark[1]{#3}{#4}%
  \@writebibtoc{\protect\bibtocline{bibbk}{#5}{#4}}%
  \bibmark{book}{#2}%
  \global\let\curr@ch\@empty
  \bibbookend
  \ifdoublecol\begin{multicols}{2}\fi
}

\def\@bibbook#1#2#3#4[#5]{%
  % #1 title to go on the first page.
  % #2 title to go into the heading.
  % #3 title to go in the PDF bookmark.
  % #4 anchor for references.
  % #5 optional TOC entry, if absent then #3 (bookmark name) is used.
  \setcounter{sedernum}{0}%
  \setcounter{parashanum}{1}%
  \maintextfalse
%\def\bk@iiijohn{3Jo}
%\def\bkn{#4}
%\ifx\bkn\bk@iiijohn\vspace*{1cm}\else\newpage\fi\thispagestyle{empty}%
  \ifnobooknewpage\else\newpage\fi
  \bibbookbegin
  %\filbreak % TODO
  \ifembedsrc
    \embedsrcfalse % attach on the first page of the first book
    \attachfile[description={Source}]{\jobname.txt}%
  \fi
  \label{#4}%
  \hypertarget{#4}{}%
  \bibpdfbookmark[1]{#3}{#4}%
  \@writebibtoc{\protect\bibtocline{bibbk}{#5}{#4}}%
%  \ifnoinlinetitle\else
%  \Needspace{3\baselineskip}%
%   \vskip\bibtitlepreskip
%    {\centering\bibtitlefont#1\\}
%   \vskip\bibtitlepostskip
%  \fi
  \begin{center}%
    \bibtitlefont#1\iftitledot.\fi
  \end{center}%
  %XXX-ZOHRAB uncomment when Zohrab Bible is done! \thispagestyle{empty}%
  \bibmark{book}{#2}%
  \ifhebrew\bibmark{oddhead}{#2}\fi
  \iffwnp
    \stepcounter{wordnum}%
    \protected@write\tf@fwnp{}{\thewordnum\space\thepage\space\string\newbook{#4}}%
  \fi
  \maintexttrue
  \global\let\curr@ch\@empty
  \bibbookend
  \ifdoublecol\begin{multicols}{2}\fi
}

\RequirePackage{keyval}
\define@key{bibbooks}{inline}{\@namedef{bibbooks@\curr@book @inline}{#1}}
\define@key{bibbooks}{toc}{\@namedef{bibbooks@\curr@book @toc}{#1}}
\define@key{bibbooks}{bookmark}{\@namedef{bibbooks@\curr@book @bookmark}{#1}}
\define@key{bibbooks}{header}{\@namedef{bibbooks@\curr@book @header}{#1}}
\define@key{bibbooks}{headerleft}{\@namedef{bibbooks@\curr@book @headerleft}{#1}}
\define@key{bibbooks}{headerright}{\@namedef{bibbooks@\curr@book @headerright}{#1}}
\define@key{bibbooks}{abbr}{\protected@write\@auxout{}{\string\setbibbookattr{\curr@book}{abbr}{#1}}}
\def\bibbookattr#1#2{\csname bibbooks@#1@#2\endcsname}
\def\setbibbookattr#1#2#3{\global\@namedef{bibbooks@#1@#2}{#3}}
\def\bibbookdescr#1#2{\def\curr@book{#1}\setkeys{bibbooks}{#2}%
  \@bibbook
    {\bibbookattr{#1}{inline}}%
    {\bibbookattr{#1}{header}}%
    {\bibbookattr{#1}{bookmark}}%
    {#1}[\bibbookattr{#1}{toc}]}

\def\ubookdescr#1#2{\def\curr@book{#1}\setkeys{bibbooks}{#2}%
  \@ubook
    {\bibbookattr{#1}{inline}}%
    {\bibbookattr{#1}{header}}%
    {\bibbookattr{#1}{bookmark}}%
    {#1}[\bibbookattr{#1}{toc}]}


\newwrite\tf@fn@chk
\immediate\openout\tf@fn@chk\jobname.fnchk
\newcounter{fn@seq}
\protected\def\fn@chk@a{\stepcounter{fn@seq}\protected@write\tf@fn@chk{}{a \thefn@seq\space\thepage}}
\protected\def\fn@chk@b{\protected@write\tf@fn@chk{}{b \thefn@seq\space\thepage}}
\protected\def\bib@footnote#1{\fn@chk@a\footnote{\fn@chk@b #1}}
\protected\def\bib@footnotetext#1{\fn@chk@a\footnotetext{\fn@chk@b #1}}

% left-to-right footnotes
\def\fntlr#1{%
  \leavevmode\unskip
  \ifnofn\else
    \stepcounter{numfnt}%
    \bib@footnotetext{\nodiacriticsfalse\mbox{}\\\beginL\maintextfalse#1\hfill\endL\mbox{}\\}%
  \fi
}

\def\fnlr#1{%
  \leavevmode\unskip
  \ifnofn\else
    \stepcounter{numfnt}%
    \bib@footnote{\beginL\maintextfalse#1\hfill\endL}%
  \fi
}

\def\fnt#1{%
  \leavevmode\unskip
  \ifnofn\else
    \stepcounter{numfnt}%
    \bib@footnotetext{\nodiacriticsfalse\bibnotelang{#1}}%
  \fi
}

\newcommand{\fnmvs}[2]{%
  \leavevmode\unskip
  \ifnofn\else
    \stepcounter{numfnt}%
    \stepcounter{nnotes}%
      \ifhebrew
        \bib@footnotetext{\nodiacriticsfalse\maintextfalse
          \beginL{\bibfnvssize#1}\endL\nobreakspace#2}%
      \else
        \bib@footnotetext{%
          {\bibfnvssize\textlatin{#1}}\nobreakspace\bibnotelang{#2}}%
      \fi
  \fi
}

\newif\ifenumfn
\enumfntrue

% typesets the first argument in bold followed by the second argument.
\def\fnote#1#2{%
  \leavevmode\unskip
  \ifnofn\else
    \stepcounter{numfnt}%
    \stepcounter{nnotes}%
    \ifenumfn
      \ifnum\c@nnotes=1 % first note in this chapter
          \bib@footnotetext{%
            {\bibfnchapsize\thechnum.\bibfnvssize\curr@vs}\nobreakspace\textbf{#1:}\nobreakspace{#2}}%
      \else
          \bib@footnotetext{%
            {\bibfnvssize\curr@vs}\nobreakspace\textbf{#1:}\nobreakspace{#2}}%
      \fi
    \else
      \bib@footnotetext{\textbf{#1:}\nobreakspace{#2}}%
    \fi
  \fi
}

% polyglot footnotes (per verse apparatus)
\def\vfn#1{%
  \leavevmode\unskip
  \stepcounter{numfnt}%
  \stepcounter{nnotes}%
  \ifnum\c@nnotes=1 % first note in this chapter
    \bib@footnotetext{\nodiacriticsfalse\maintextfalse{\bibfnchapsize\thechnum.\bibfnvssize\curr@vs}\nobreakspace#1}%
  \else
    \bib@footnotetext{\nodiacriticsfalse\maintextfalse{\bibfnvssize\curr@vs}\nobreakspace#1}%
  \fi
}


% polyglot footnotes (per page apparatus) print chapter/verse only for the first footnote in a verse
\def\polyfn#1{%
  \leavevmode\unskip
  \stepcounter{numfnt}%
  \stepcounter{nnotes}%
  \stepcounter{nvsnotes}%
  \ifnum\c@nnotes=1 % first note in this chapter
    \bib@footnotetext{\nodiacriticsfalse{\bibfnchapsize\thechnum.\bibfnvssize\curr@vs}\nobreakspace#1}%
  \else
    \ifnum\c@nvsnotes=1 % first note in this verse (for some reason this code doesn't work!)
      \bib@footnotetext{\nodiacriticsfalse{\bibfnvssize\curr@vs}\nobreakspace#1}%
    \else
      \bib@footnotetext{\nodiacriticsfalse\nsep\nobreakspace#1}%
    \fi
  \fi
}

\def\fn#1{%
  \leavevmode\unskip
  \ifnofn\else
    \stepcounter{numfnt}%
    \stepcounter{nnotes}%
    \ifnum\c@nnotes=1 % first note in this chapter
      \ifhebrew
        \bib@footnotetext{\nodiacriticsfalse\maintextfalse
          {\bibfnchapsize\iflrfn\thechnum.\else\hebrewnum{\thechnum}\fi}\bibfnvsnumspace
          \beginL{\bibfnvssize\bfseries\curr@vs}\endL\bibfnvsnumspace#1}%
      \else
        \bib@footnotetext{%
          {\bibfnchapsize\thechnum.}{\bibfnvssize\bibfnvsmark\curr@vs}\bibfnvsnumspace\bibnotelang{#1}}%
      \fi
    \else
      \ifhebrew
        \bib@footnotetext{\nodiacriticsfalse\maintextfalse
          \beginL{\bfseries\curr@vs}\endL\bibfnvsnumspace#1}%
      \else
        \bib@footnotetext{%
          {\bibfnvssize\bibfnvsmark\curr@vs}\bibfnvsnumspace\bibnotelang{#1}}%
      \fi
    \fi
  \fi
}

\ifbigfoot
  % FIXME: why \@stars gets called with big value on the first pass, and \@ctrerr is triggered
  \def\@stars#1{\ifcase#1\or *\or **\or ***\or ****\or *****\else \wlog{stars: \the#1}\fi}%\@ctrerr
  \DeclareNewFootnote[para]{STARS}[stars]
  \MakePerPage{footnoteSTARS}
  \def\@makefnmark@STARS{{\normalfont\@thefnmark}}
  \def\fns#1{{\let\@makefnmark\@makefnmark@STARS\fn@chk@a\footnoteSTARS{\fn@chk@b #1}}}
\else
  \ifxetex
    \DefineFNsymbols*{stars}[text]{{*}{**}{***}{****}{*****}}
  \else
    \DefineFNsymbols*{stars}{{*}{{*}{*}}{{*}{*}{*}}{{*}{*}{*}{*}}{{*}{*}{*}{*}{*}}}
  \fi
  \renewcommand\thefootnote{\@fnsymbol\c@footnote}
  \def\fns#1{{\setfnsymbol{stars}\bib@footnote{#1}}}
\fi

\ifxrefs
% FIXME: would it be better to remove "parindent" in the xref footnotes, i.e. flush them to the left?
% (tried redefining \FN@par and \FN@indent but that didn't work - need to look more)
\DeclareNewFootnote[para]{XREF}
\def\thefootnoteXREF{}
\def\fnxref#1{%
  \leavevmode\unskip
  \stepcounter{numfnt}%
  \stepcounter{nnotes}%
  \fn@chk@a\footnotetextXREF{\fn@chk@b
    \parindent\z@
    %\ifnum\c@nnotes=\@ne{\bibfnchapsize\bibchapname\nobreakspace\thechnum. }\fi % first note in this chapter
    {\bibfnvssize[\ifnum\c@nnotes=\@ne\thechnum:\fi\curr@vs]}\nobreakspace\bibnotelang{#1}}%
}
\def\bibxra#1#2#3#4{\bibref@c[\bk{#1} #4]{#1 #2:#3}}
\def\bibxrb#1#2#3#4{\bibref@c[#4]{#1 #2:#3}}
\def\bibxrc#1#2{\hyperlink{#1_#2.2}{\bk{#1} #2}}
\def\bibxrd#1#2#3{\hyperlink{#1_#2.2}{#3}}
\input xrefs.tex
\fi
\protected\def\bookxref#1{\ifxrefs\textsuperscript{\small\upshape (\cyra)}\footnotetextXREF{{\bibfnvssize [\cyra]}\nobreakspace\bibref{#1}}\fi}

% footnote with a little circle in the text.
\def\fnc#1{\r{}\fn{#1}}
\def\fnst#1{\ignorespaces\ts{*}\fn{#1}}

\def\record@totalfnt{%
  \immediate\write\@mainaux{\string\gdef\string\totalfnt{\thenumfnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalalfnt{\thenumalfnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalafnt{\thenumafnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalbfnt{\thenumbfnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalcfnt{\thenumcfnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totaldfnt{\thenumdfnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalefnt{\thenumefnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalffnt{\thenumffnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalifnt{\thenumifnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totaljfnt{\thenumjfnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totallfnt{\thenumlfnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalnfnt{\thenumnfnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalmajfnt{\thenummajfnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalpfnt{\thenumpfnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalwfnt{\thenumwfnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalarmfnt{\thenumarmfnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalcofnt{\thenumcofnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalgeofnt{\thenumgeofnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalgotfnt{\thenumgotfnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalethfnt{\thenumethfnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalslafnt{\thenumslafnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalsyrfnt{\thenumsyrfnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalitfnt{\thenumitfnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totalvgfnt{\thenumvgfnt}}%
  \immediate\write\@mainaux{\string\gdef\string\totallattfnt{\thenumlattfnt}}%
}
\AtEndDocument{\record@totalfnt}
\def\totalfnt{}
\def\totalalfnt{}
\def\totalafnt{}
\def\totalbfnt{}
\def\totalcfnt{}
\def\totaldfnt{}
\def\totalefnt{}
\def\totalffnt{}
\def\totalifnt{}
\def\totaljfnt{}
\def\totallfnt{}
\def\totalnfnt{}
\def\totalmajfnt{}
\def\totalpfnt{}
\def\totalwfnt{}
\def\totalarmfnt{}
\def\totalcofnt{}
\def\totalgeofnt{}
\def\totalgotfnt{}
\def\totalethfnt{}
\def\totalslafnt{}
\def\totalsyrfnt{}
\def\totalitfnt{}
\def\totalvgfnt{}
\def\totallattfnt{}

% table of contents generation
\multicolsep=0pt
\columnseprule=0.4pt
\def\@pnumwidth{27pt}
\def\@tocrmarg{25pt}
\AtEndDocument{%
  \immediate\write\@mainaux{\string\@writefile{bibtoc}{\string\bibtocfinish}}%
  \newwrite\tf@bibtoc
  \immediate\openout\tf@bibtoc\jobname.bibtoc
}
\def\bibpart#1#2#3{%
  %\ifnobooknewpage\else\clp\fi
  \bibpdfbookmark{#2}{#3}%
  \@writebibtoc{\protect\bibtocline{bibpt}{#1}{#3}}%
}
\def\@writebibtoc#1{%
  \protected@write\@mainaux{\ifhebrew\Hsafemacros\fi}{\string\@writefile{bibtoc}{#1}}%
}
\def\bibtoc@style@onecol{onecol}
\def\bibtoc@style@twocol{twocol}
\def\bibtocline#1{\csname l@#1\endcsname}
\def\bibtocpgmark#1{\leftline{\hb@xt@\@pnumwidth{\hfil\fontsize{10}{12}\selectfont#1}}}
\ifhebrew
  % this special case is needed only because of a bug in pdfetex with hrefs in RL mode
  \def\@dottedhtocline#1#2#3#4#5{%
    \vskip \z@ \@plus.2\p@
    {\leftskip #2\relax \rightskip \@tocrmarg \parfillskip -\rightskip
     \parindent #2\relax\@afterindenttrue
     \interlinepenalty\@M
     \leavevmode
     \@tempdima #3\relax
     \advance\leftskip \@tempdima \null\nobreak\hskip -\leftskip
     \hb@xt@\@pnumwidth{\hfil\normalfont \normalcolor #5}%
     \leaders\hbox{$\m@th
        \mkern \@dotsep mu\hbox{.}\mkern \@dotsep
        mu$}\hfill
     {#4}\nobreak
     \par}%
  }
  \def\l@bibbk#1#2{\@dottedhtocline{1}{0pt}{0pt}{#1}{\bibpr{#2}}}
\else
  \def\l@bibbk#1#2{\@dottedtocline{1}{0pt}{0pt}{#1}{\bibpr{#2}}}
\fi
\def\l@bibpt#1#2{%
  \ifx\bibtoc@style\bibtoc@style@twocol
   \ifnum\col@number>\@ne\end{multicols}\fi
  \fi
  %\vspace*{\stretch{1}}%
  \begin{center}\bibtocheadfont#1\end{center}%
  \ifx\bibtoc@style\bibtoc@style@twocol
    \@@line{\hss\small\bibpage\hb@xt@\columnsep
      {\hss\vrule\@height.7\baselineskip\@depth.7\baselineskip\@width\columnseprule\hss}\hss\small\bibpage}%
    \begin{multicols}{2}%
    \raggedcolumns
  \else
    \rightline{\small\bibpage}%
  \fi
}
\def\bibtocfinish{\ifx\bibtoc@style\bibtoc@style@twocol\ifnum\col@number>\@ne\end{multicols}\fi\clearpage\fi}
\def\bibtableofcontents#1{%
  \def\bibtoc@style{#1}%
  \bibpdfbookmark{\bibcontname}{cnt}%
  \bibtocfont
  \thispagestyle{empty}%
  \@input{\jobname.bibtoc}%
}

% marks emulation via \write to avoid conflict with marn package
\def\write@mark#1#2{%
  \@ifundefined{c@mark@serial@#1}{\newcounter{mark@serial@#1}}{}%
  \stepcounter{mark@serial@#1}%
  \protected@write\@auxout{}{\protect\process@mark{#1}{\the\value{mark@serial@#1}}{\thepage}{#2}}%
}
\def\process@mark#1#2#3#4{%
  \@ifundefined{mark@#1@#3}{%
    \global\@namedef{mark@#1@#3}{{#2}{#4}{#2}{#4}}%
  }{%
    \expandafter\set@marks@a\csname mark@#1@#3\endcsname{#2}{#4}%
  }%
}
\def\set@marks@a#1#2#3{%
  \expandafter\set@marks@b#1#1{#2}{#3}%
  \expandafter\set@marks@c#1#1{#2}{#3}%
}
\def\set@marks@b#1#2#3#4#5#6#7{\ifnum #6<#1 \gdef#5{{#6}{#7}{#3}{#4}}\fi}
\def\set@marks@c#1#2#3#4#5#6#7{\ifnum #6>#3 \gdef#5{{#1}{#2}{#6}{#7}}\fi}

\newcommand{\mref}[1]{\bibrevmarn{\normalfont\textlatin{\scriptsize#1}}}

\ifgreek
\RequirePackage{amsmath}

\newcommand{\nkephal}[2]{%
   \centerline{\normalsize\slshape\gknum{#1} #2}%
}

\newcommand{\kephal}[1]{%
   \bibrevmarn{\textit{#1}}%
}

\newcommand{\euseb}[2]{%
   \bibrevmarn{\ensuremath{\genfrac{}{}{0pt}{}{#1}{\@Roman{#2}}}}%
}
\fi

% redefine the \include behavior to not use \clearpage
% (needed e.g. for two-column layout to prevent unbalanced columns)
% don't \end{multicols} unless we are using doublecol option
% XXX temporary comment out the following re-def as we don't need it for most Bibles.
%\def\@include#1 {%
%  \@tempswatrue
%  \if@partsw
%    \@tempswafalse
%    \edef\reserved@b{#1}%
%    \@for\reserved@a:=\@partlist\do
%      {\ifx\reserved@a\reserved@b\@tempswatrue\fi}%
%  \fi
%  \if@tempswa
%    \@input{#1.tex}%
%    \ifdoublecol\ifnum\col@number>\@ne\end{multicols}\fi\fi
%  \fi
%}

% new datetime package must be loaded after babel
\RequirePackage{datetime}
\def\DTtoday{\formatdate{\day}{\month}{\year}}
\def\shorttoday{{\shortdate\showdowfalse\formatdate{\day}{\month}{\year}}}

% conditional markup tuning, to maintain more than 1 version of module sources with hand-tuned markup
\def\tunemarkuptag#1{\@namedef{tune@markup@#1}{}}
\def\tunemarkup#1#2{\@ifundefined{tune@markup@#1}{}{#2}}
